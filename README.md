# 读者之旅 Reader’s Journey

离线纯前端的阅读 RPG 应用（v1.8.0）。

## v1.8.0 真全屏 + 高清卡通世界重制

1. 全端改为真全屏：移除居中 430 宽手机框，`#app-shell` 统一铺满 `100vw x 100dvh`。
2. 继续保持竖屏优先交互密度：移动端与常见手机视口保持单手可点，文本不半截。
3. 主世界渲染从像素模式切换为高清卡通参数（抗锯齿开启、像素锁定关闭）。
4. 世界地表/水面/道路与环境层做统一色调强化，地图主体视觉变化显著可见。
5. Service Worker 缓存版本升级，避免用户因旧缓存看不到最新视觉改版。
6. E2E 壳层断言更新为“全屏占满”标准，并保留移动端竖屏优先检查。

## v1.7.6 全局视觉统一（参考图风格收口）

1. 全局 UI 统一为“木框 + 羊皮纸 + 经营风高对比按钮”视觉语言，覆盖世界 HUD、弹层、卡片、列表与底部导航。
2. 关键交互按钮语义分色收口：主动作（绿色）、次动作（蓝色）与危险动作（红色）层级更清晰，点击反馈一致。
3. 文本可读性强化：录入列表、通用条目、藏书阁书名/元信息统一 2 行截断与自动换行，移动端避免半截/遮挡。
4. 藏书阁书卡进一步优化：页进度、状态、双按钮操作区在小屏仍保持完整触控与信息可读。
5. 穷尽测试脚本增强设置流鲁棒性（重试 + fallback 选择器），并刷新视觉基线，确保 `e2e/headed/visual` 可稳定通过。

## v1.7.5 藏书阁 UI 深化 + 编辑页数

1. 藏书阁书卡改为“信息区 + 操作区”结构，状态徽章回归流式布局，长书名/长作者在移动端保持可读。
2. 每本书新增“编辑页数”按钮，可直接修正总页数（1~4000），用于不同版本页数差异校正。
3. 保存页数后自动保持已读页数（超出自动截断），并重算进度与状态（planned/reading/finished）。
4. 编辑页数仅做元数据校正，不触发经验/属性/技能奖励。
5. 穷尽 E2E 增加断言链：编辑页数入口可见、保存后卡片总页更新、详情页“共X页”一致。

## v1.7.4 藏书阁大书架分页改造

1. 藏书阁从“单列长卡片”升级为“木质分层书架”，每层并列展示多本书（竖屏默认 3 本/层，极窄屏 2 本/层）。
2. 新增书架筛选（全部/在读/待开始/已完成）与分页，书籍数量大时不再依赖超长滚动。
3. 书籍卡片保留原有详情入口与进度显示，点击任意书卷仍进入同一套“书卷详情”流程。
4. 穷尽 E2E 增加藏书阁断言：首层并列数量、分页翻页、翻页后首本 UID 变化、详情标题匹配。

## v1.7.3 全局竖屏化（手机单手优先）

1. 全游戏 UI 改为竖屏应用框：主界面与所有 Sheet 统一在竖向画幅内展示。
2. 桌面与横屏场景保持可用：不强制拦截横屏，但依然以居中竖屏框渲染，避免横向铺满导致阅读成本上升。
3. PWA 清单增加 `orientation: "portrait"`，安装态优先竖屏使用。
4. E2E 新增竖屏壳层断言：要求 `#app-shell` 满足高度大于宽度并保持居中。

## v1.7 全量交付（穷尽测试 + 木质卷轴农场风）

1. 世界渲染稳定：修复 Phaser 兼容导致的“蓝底空白但有音乐”问题，世界地图稳定可见可交互。
2. 纯游戏内 HUD：主世界去外框化，提示、登记、分享入口全部内置在游戏界面。
3. 视觉重制：统一为木质卷轴农场风（纸感面板、木纹按钮、经营风状态徽章），玩法与数值规则保持不变。
4. 穷尽回归：新增 `scripts/e2e-exhaustive.mjs`，覆盖世界移动、5 大热点、录入/面板/藏书/分享/设置、多层弹层链路。
5. 视觉回归：`scripts/visual-regression.mjs` 已适配世界内入口流，支持基线与检查模式。
6. 保持测试接口兼容：`window.render_game_to_text` 与 `window.advanceTime(ms)` 不变，并补充了仅测试用 `window.__RJ_TEST__` 钩子。

## v1.7.1 视觉工具链与主世界 HUD 升级

1. 主世界新增概览 HUD：显示“今日已阅读页数”和“最近/正在前往地标”，并随探索状态自动更新。
2. 主世界右上“登记/分享”按钮按语义分色并增强 hover/focus 可见性，移动端小屏避免裁切。
3. 新增 UI 验证流水线脚本：`scripts/ui-pipeline.mjs`，支持 `ui:check` 与 `ui:baseline`。
4. 新增视觉工具链文档：`docs/visual-toolchain.md`（设计系统、E2E、视觉回归、基线更新流程）。

## v1.7.2 技能星图阶梯扩展

1. 技能系统扩展为 4 条路径 × 5 阶梯（共 20 技能），每条路径支持逐阶解锁与前置依赖。
2. 星图神殿新增“路径阶梯进度”展示：每条路径显示已解锁数量、下一阶目标与当前条件进度。
3. 技能明细改为按路径分组、按 T1→T5 排序，支持更清晰的成长路线阅读。
4. e2e 脚本修复了书卷感触输入的可见性判定，避免 DOM 存在但不可编辑时的误超时。

## v1.6.2 世界渲染修复与纯游戏内 HUD

1. 修复主世界偶发“蓝底空白但有音乐”的渲染故障（Phaser tween 接口兼容问题）。
2. 主世界改为纯游戏画面：世界场景隐藏外层顶部/底部 DOM HUD。
3. 提示文案迁入画布内 HUD，避免外框遮挡与割裂感。
4. 新增画布内“登记 / 分享”按钮，直接复用原有录入与分享 Sheet 逻辑。
5. 保持 `window.render_game_to_text` 与 `window.advanceTime(ms)` 测试接口不变。

## v1.6.1 游戏化与可读性改造

1. 布局从“严格一屏硬裁剪”改为“可读性优先”：主内容允许纵向滚动，保留 Sheet 承载详情，彻底规避半截文本。
2. 右上角新增分享图标，底部移除“分享”Tab；分享改为随时可开的证书 Sheet。
3. 新增 Phaser 主世界场景（默认首页）：角色可在地图中自由移动（上下左右与斜向），点击设施自动靠近并交互。
4. 主世界升级为“全屏视口 + 可探索大地图”：设施从平面图标改为建筑化交互点，加入路径、星空、粒子与靠近高亮反馈。
5. 面板升级为 RPG 形态：六维属性全量常驻（图标 + 数值 + 等级段位 + 能量条）。
6. 技能区升级为“星图分布”交互：点亮星点、自动装备 3 槽、节点可点击查看详情。
7. 卷轴视觉升级为“卷芯 + 纸面展开”的魔法卷轴样式，交互从卡片展开改为卷轴展开体感。
8. BGM 重生成为更悠远长音双轨（约 70 秒循环），弱化节拍起伏，保留跨场景 crossfade。
9. 保留并增强点击反馈（粒子、Toast、轻触音、震感预留），强化“阅读即升级”的即时满足感。

## 产品定位

1. 将阅读行为游戏化，让成长“可见、可结算、可回看”。
2. 纯前端离线优先，主流程不依赖后端。
3. 核心流程：主世界探索 -> 与设施交互完成录入/成长/藏书/设置（主世界可直接点画布内“分享”按钮）。

## 页面边界（v1.6）

### 保留主界面
1. 主世界页（唯一主界面）
2. 录入台 Sheet
3. 星图神殿 Sheet（面板）
4. 藏书阁 Sheet
5. 工坊设置 Sheet

### 删除模块/页面
1. AI 书童助手
2. 下一本推荐页与导航入口
3. 独立进度页（已并入面板书卷详情）
4. 购书跳转与联盟导流
5. 底部分享入口（已收敛为主世界内置按钮 + 非世界页右上角入口）

## 功能清单

### 录入台（世界交互）
1. 离线书库搜索（书名/作者/ISBN）。
2. 手动联网搜索（Open Library + Google Books），失败自动降级。
3. 书库选择入库 + 自编录入兜底（自编奖励 x0.7）。
4. 分类必选。
5. 搜索结果“查看更多”走 Sheet 分段加载。

### 主世界
1. Phaser 主世界地图，角色可 8 方向移动（键盘与触屏点地移动）。
2. 交互点：录入台、属性镜、藏书阁、信使鸽、工坊。
3. 点击交互点：若距离足够则立即交互；若距离过远则自动走近后交互。
4. 世界 HUD 内置于画布：显示等级、完成进度、交互提示。
5. 画布内固定按钮：登记、分享（语义分色）。
6. 新增概览 HUD：今日已阅读（X页）+ 最近地标/自动寻路目标提示。
7. “今日已阅读”按书卷详情保存时的已读页数净增量累计（delta>0），跨天自动重置为 0。
8. 所有 Sheet 头部提供“返回上一层 + 回到世界”双按钮导航（支持多层弹层回退）。
9. 检索结果若显示“页数待核实”，系统会先尝试联网核验真实页数；核验失败时会拦截录入并引导改用自编录入填写真实页数（不再默认落成 320 页）。

### 星图神殿（世界交互）
1. 六维属性全量展示（含图标、数值动画、段位标记、能量条）。
2. 等级经验主线 + 经验条同步动画。
3. 技能星图：4 路径 × 5 阶梯分布、解锁高亮、自动装备 3 槽，并显示路径阶梯进度（下一阶目标/条件）。
4. 成就摘要与技能/成就详情 Sheet。

### 藏书阁（世界交互）
1. 大书架分层布局：每层并列多本书卷，减少竖屏滚动长度。
2. 筛选 + 分页：全部/在读/待开始/已完成，按页浏览。
3. 书卷点击进入书卷详情 Sheet。
4. 每本书支持“编辑页数”：用于版本差异校正总页数，保存后自动换算进度与状态（不发奖励）。
5. 书卷详情进度编辑：输入“已读页数”自动换算百分比，同时可直接拖动进度条。
6. 感触时间线（新增/编辑/删除，单条上限 1000 字）。
7. 进度上升沿用原奖励规则结算经验/属性/技能/成就。

### 分享（主世界内置按钮 + 右上角图标）
1. 主世界可直接点击画布内“分享”按钮打开“星图证书”Sheet。
2. 非主世界页面可点右上角图标打开“星图证书”Sheet。
3. 支持昵称编辑、复制邀请码、复制分享文案。
4. 保留证书闪光反馈与复制成功提示。

### 工坊设置（世界交互）
1. 音频控制（仅背景音乐开关 + 提示音开关 + 播放状态）。
2. 隐私政策入口（App 内）。
3. 数据导出、导入、重置。
4. 本机存储状态与最后保存时间。
5. 版本号、支持邮箱。
6. 明确提示“数据仅保存在本机”。

## 数值规则

1. 历史权重：前10本100%，10-50本70%，50+本30%。
2. 每日录入节奏：第1本100%，第2本80%，第3本及以上50%。
3. 新增书奖励：x1.5。
4. 自编录入奖励：x0.7。
5. 录入台意志增益：按录入经验点的 45% 折算（至少 +1），避免意志力单项过快拉升。
6. 进度结算沿用既有规则（经验、属性、技能、成就）。

## 离线数据方案

1. 预置离线书库随应用打包（当前约 5 万本，中文热门优先）。
2. 用户数据本机持久化（localStorage）。
3. 支持 JSON 导出/导入，旧版本数据自动迁移到 schema v4。
4. 新增字段：`book.reflections[]`、`book.updatedAt`。
5. 不做自动云同步。

## 真实书籍数据来源

1. `doubanbook30000`（中文热门覆盖）。
2. Open Library 搜索数据快照补全。
3. Douban Top250 热门种子校验。
4. 数据索引：`src/data/catalog/index.json`。
5. 分片目录：`src/data/catalog/shards/`。

## 素材与音频

1. 字体：Noto Sans/Serif CJK SC（离线内置）。
2. 图标：项目内 SVG。
3. 音频：本地脚本生成 `src/assets/audio/*.wav`（提示音 + 轻触音效 + 长音氛围双轨 BGM），由 Howler 播放与混音。
4. 动效：页面切换、结算反馈、Sheet 入场 + Lottie 头部微动效，支持 `prefers-reduced-motion`。
5. 面板新增星图技能节点与卷轴展开动画。
6. 许可记录：`docs/assets-license.md`。

## 技术架构

1. HTML + CSS + JavaScript（PWA）+ Phaser 3（世界场景）。
2. Service Worker 离线缓存。
3. 纯前端离线优先，不引入后端。
4. 联网搜索为用户手动触发，可失败降级。

## 验收标准

1. 断网下可完成录入、面板更新、藏书阁编辑、分享、设置核心流程。
2. 录入页联网搜索在超时/失败后按钮必恢复可点击。
3. 常见 iPhone 尺寸下页面无半截文本，主内容可滚动，详情走 Sheet。
4. 面板可直接改进度与维护感触时间线。
5. `npm run lint`、`npm test`、`npm run build` 全通过。

## 本地运行

1. 安装依赖（CI 一致）：`npm ci`
2. 启动开发服务：`npm run dev`
3. 代码检查：`npm run lint`
4. 单元测试：`npm test`
5. 构建：`npm run build`
6. 穷尽 E2E（headless）：`npm run test:e2e`
7. 穷尽 E2E（headed 可视检查）：`npm run test:e2e:headed`
8. 生成视觉回归基线截图：`npm run visual:baseline`
9. 执行视觉回归检查：`npm run visual:check`
10. 一键 UI 检查流水线：`npm run ui:check`
11. 一键 UI 基线流水线：`npm run ui:baseline`
12. 预览构建产物：`npm run preview`
13. 生成/更新音频素材：`npm run assets:audio`
14. 同步第三方运行时（Howler/Lottie）到本地：`npm run assets:vendor`

## 项目结构

1. `src/index.html` 页面结构
2. `src/styles.css` 样式系统、RPG 面板、卷轴与星图动效
3. `src/app.mjs` 状态、交互、音频、分享 Sheet 与成长反馈流程
4. `src/lib/state.mjs` 本地状态与迁移（schema v4）
5. `src/lib/reward-engine.mjs` 奖励结算引擎
6. `src/data/catalog/*` 离线书库与索引
7. `scripts/generate-audio-assets.mjs` 长音环境 BGM 与提示音生成脚本
8. `scripts/sync-vendor-assets.mjs` 第三方运行时同步脚本
9. `scripts/e2e-exhaustive.mjs` Playwright 穷尽交互测试脚本
10. `scripts/visual-regression.mjs` Playwright 截图与像素对比脚本（世界内入口流）
11. `scripts/ui-pipeline.mjs` UI 验证流水线（lint/test/build/e2e/visual）
12. `src/assets/vendor/*.js` 离线运行时库（Howler/Lottie/Phaser）
13. `src/assets/animations/*.json` Lottie 动效数据
14. `docs/assets-license.md` 数据与素材许可说明
15. `docs/visual-toolchain.md` 视觉工具链与基线更新说明
